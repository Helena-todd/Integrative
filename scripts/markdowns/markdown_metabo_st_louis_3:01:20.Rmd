---
title: "Metabolomics_St_Louis"
author: "helena"
date: "4/10/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r imports, echo=FALSE, results='hide', warning = FALSE}
suppressPackageStartupMessages({
  library(dplyr)
  library(openxlsx)
  library(metabolomics)
  library(BioGVHD)
  library(tidyverse)
  library(data.table)
  library(dendextend)
  library(ggplot2)
  library(mlbench)
  library(caret)
  library(nnet)
  library(pROC)
  library(igraph)
  library(VennDiagram)
  library(boot)
  library(qsub)
  library(gridExtra)
})
options("scipen"=100)
```


# Preprocessing of the data

I first read in the clinical and metabolomics data:

```{r load_data}
samp_rd <- read.xlsx("~/Documents/VIB/Projects/Integrative_Paris/Local_cohort/Data synthesis local cohort Saint-Louis 17012019.xlsx")
samp_rd$DOB <- as.Date(samp_rd$DOB, format = "%d.%m.%Y")
samp_rd$DOG <- as.Date(samp_rd$DOG, format = "%d.%m.%Y")
samp_rd$DATEOFSAMPLE <- as.Date(samp_rd$DATEOFSAMPLE, format = "%d.%m.%Y")

info <- extract_info_metabo(metadata_file = samp_rd,
                            metabo_file = "~/Documents/VIB/Projects/Integrative_Paris/Local_cohort/Metabo/Metabolomic local cohort Saint-Louis_filtered.xlsx")
rd_meta <- info$subset_meta
meta_metabo <- info$meta_metabo
data_metabolites <- info$data_metabolites
```

I generate the age and gender vectors that will be used for modeling in 
all patient groups (donors, recipients and couples).
These vectors are :
- gender_comp : the donor and recipient gender ("FM", "FF", "MF" or "MM")
- age_recip : the age of the recipient

```{r, echo = FALSE}
couple_info <- rd_meta %>% 
  arrange(COUPLENUMBER) %>% 
  dplyr::select(c("COUPLENUMBER", "GENDER", "DOG", "DOB", "GROUP")) %>% 
  rownames_to_column("rn") %>% 
  mutate(GROUP = as.factor(tolower(GROUP))) %>% 
  column_to_rownames("rn")
  
gender_donors <- couple_info$GENDER[c(TRUE,FALSE)]
gender_recip <- couple_info$GENDER[c(FALSE,TRUE)]
gender_comp <- paste0(gender_donors, gender_recip)

age_recip <- couple_info$DOG[c(FALSE,TRUE)] - couple_info$DOB[c(FALSE,TRUE)]

couple_info <- couple_info %>% 
  rownames_to_column("rownames") %>% 
  mutate(gender_comp = rep(gender_comp, each = 2),
         age_recip = rep(age_recip, each = 2)) %>% 
  column_to_rownames("rownames")
head(couple_info)
```


I then filter out the metabolies that are xenobiotics drugs, as well as the metabolites which are not common to both the St Louis and the Cryostem cohort:

```{r}
data_metabolites <- data_metabolites[,-which((meta_metabo[2,]=="Xenobiotics")&(meta_metabo[1,]=="Drug"))] # rm drug xenobiotics
data_metabo_national <- read.xlsx("~/Documents/VIB/Projects/Integrative_Paris/National_cohort/Metabo/Metabo NATIONAL cohort CRYOSTEM.xlsx")
national_metabolites <- data_metabo_national$X1[-c(1,2)]
# remove metabolites that are not present in both the national and the St_Louis cohort :
data_metabolites <- data_metabolites[,which(colnames(data_metabolites) %in% national_metabolites)]
```

Then, I filter out the metabolites for which we have more than 50% of missing values in all our sub-groups (donors or recipients, non-tolerant, tolerant 1 or tolerant 2):
These are the metabolites that we filter out:

```{r generate_david_figure, echo = FALSE, warning=FALSE}
names_patients <- rownames(data_metabolites)

big_mat <- data_metabolites %>%
  mutate_all(as.numeric) %>%
  mutate(METABONAME = names_patients) %>%
  left_join(rd_meta[,c("GROUP", "COUPLENUMBER", "METABONAME")], by = "METABONAME") %>%
  mutate(status = ifelse(test = grepl("D", METABONAME), yes = "D", no = "R"))

na_pctgs <- big_mat %>%
  group_by(GROUP, status) %>%
  summarize_all(funs(sum(is.na(.)) / length(.)))

melted <- melt(na_pctgs, id = 1:2)

to_rm <- lapply(names(table(melted$variable)), function(metabolite){
  values <- melted$value[which(melted$variable == metabolite)]
  all(values > 0.5)
})

names2rm <- as.character(names(table(melted$variable))[which(to_rm == T)])
plot2rm <- melted[which(melted$variable %in% names2rm),]
table_pctg_na <- plot2rm %>% arrange(status) %>%
  mutate(variable = paste0(variable, GROUP))

ggplot(data = table_pctg_na,
       mapping = aes(x = variable, fill = GROUP,
                     y = ifelse(test = status == "D",
                                yes = -value, no = value))) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = abs, limits = max(table_pctg_na$value) * c(-1,1)) +
  labs(y = "pctg of NA") +
  coord_flip()

high_na <- which(to_rm==T)
data_metabo <- data_metabolites[ , -high_na]
```

I then replace the missing values by 1/2 of the smallest value measured for each metabolite plus some noise:

```{r, results = 'hide', message = FALSE, warning = FALSE}
for(i in 1:ncol(data_metabo)){ #replace remaining NA by 1/2 min column value + noise
  x <- data_metabo[,i]
  to_replace <- data_metabo[is.na(x),i]
  with_noise <- jitter(rep(0.5*(min(as.numeric(x[-which(is.na(x))]))), length(to_replace)))
  data_metabo[is.na(x),i] <- with_noise
}
```


I then filter out the metabolites that do not vary enough across patients:

```{r}
sds <- apply(data_metabo,2,sd)
plot(sort(sds), type = "l", ylim = c(0,10^7))
abline(h=quantile(sds, 0.23), col="red")
data_metabo <- data_metabo[,which(sds>=quantile(sds, 0.23))]
rnames <- rownames(data_metabo)
data_metabo <- apply(data_metabo,2,as.numeric)
rownames(data_metabo) <- rnames
```

And I finally log-transform, normalise and save the data : 

```{r}
mat2use <- merge.data.frame(as.data.frame(rd_meta[,2], row.names = rownames(rd_meta)),
                            data_metabo, by = "row.names") %>%
  tibble::column_to_rownames(var="Row.names")

logdata <- LogTransform(mat2use)
normdata <- Normalise(logdata$output, method = "median")
colnames(normdata$output) <- colnames(logdata$output)
norm_data <- normdata$output

# merge dataframes:
big_mat <- merge.data.frame(normdata$output, rd_meta, by = "row.names") %>%
  tibble::column_to_rownames("Row.names")

logdata <- logdata$output
meta_metabo <- meta_metabo[,which(as.character(meta_metabo[3,])%in%colnames(norm_data))] # only selected metabolites
```

# Analysis on the recipients :

First, we focus only on the metabolomics data coming from the recipients, to see
if differences in certain metabolites can explain tolerance in these patients.

```{r}
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/recip/norm_data.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/recip/meta_metabo.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/recip/big_mat.RData")
norm_data$Group <- as.factor(norm_data$Group)

samp_recip <- samp_rd[which(samp_rd$METABONAME %in% rownames(norm_data)),]
```

We can perform a principal components analysis on the recipients to see if we
would already see some structure in the data:
```{r}
pca_met <- prcomp(norm_data %>% dplyr::select(-"Group"))
```

It looks like the first principal component is by far the most informative: 
```{r}
plot(pca_met)
```

```{r, echo = FALSE}
pca_2plot <- as.data.frame(pca_met$x, stringsAsFactors = F) %>% 
  dplyr::select(PC1, PC2) %>% 
  rownames_to_column("METABONAME") %>% 
  left_join(samp_recip, by = "METABONAME")
  
ggplot(pca_2plot, aes(x = PC1, y = PC2, color = as.factor(GROUP))) +
  geom_point() +
  geom_text(aes(label=Id.Cryostem.R),hjust=0, vjust=0)
ggplot(pca_2plot, aes(x = PC1, y = PC2, color = as.factor(CMVStatus))) +
  geom_point() +
  geom_text(aes(label=Id.Cryostem.R),hjust=0, vjust=0) +
  scale_color_manual(breaks = c("0", "1"),
                     values = c("white", "black"))

```
I plot the FCS names of the recipients, for easier comparison of the metabolomics
data with the results found in the CyTOF data.
The groups already seem to be slightly separated on the first PC, with non 
tolerant recipients on the left and tolerant recipients more to the right.
I also colored the recipients per CMV status, but there doesn't seem to be a 
CMV positive group, as opposed to what was observed in the CyTOF data.


I try random forest models on all features of the recipients, to already roughly
see if there is some information in the recipients data, before performing
any feature selection : 
```{r, echo = FALSE}
colnames(norm_data) <- make.names(colnames(norm_data))

rf_recip <- randomForest::randomForest(Group~., norm_data, mtry = 40)
rf_recip
```

The classification of the recipients into three groups already gives interesting 
results, since it seems like we can classify the non tolerant and primary tolerant
patients quite accurately. However, only 2 out of the 6 secondary tolerant
recipients were correctly classified here, so we will divide the classification 
problem in two.
First, we try to classify between non tolerant and tolerant patients:

```{r, echo=FALSE}
colnames(norm_data)[1] <- "group"
norm_data$group <- as.factor(tolower(norm_data$group))

set.seed(1)
rf1 <- rf_tol_non_tol(df_orig = norm_data, mtry = 30, ntree = 10000)
rf1
```

Since the out of bag error on the model classifying tolerant from non tolerant 
recipients is quite low (and therefore the model is potenitally quite informative),
we can have a closer look at the features that were most important in this model:

```{r}
features_idx <- which(rf1$importance[,3]>=0.01)
features_of_interest <-
  rownames(rf1$importance)[features_idx]

subst.mds <- cmdscale(1 - rf1$proximity, eig=TRUE)
op <- par(pty="s")
pairs(cbind(norm_data[,names(features_idx)], subst.mds$points), cex=0.6, gap=0,
      col=c("red", "blue")[as.numeric(norm_data$group)],
      main="Predictors and MDS of Proximity Based on RandomForest")
```

We can also generate a volcano plot of the metabolites between tolerant and non 
tolerant recipients: 
I also plot boxplots of the "top metaolites" in the volcano plot.

```{r}
mat2use <- norm_data
gr <- as.character(norm_data$group)
gr[which(gr!= "non_tolerant")] <- "tolerant"
mat2use$group <- as.factor(gr)

res <- TwoGroup(mat2use)
VolcanoPlot(res$output[,4], res$output[,2], cexlab = 0.6)
MetBoxPlots(mat2use, "glycocholate",cols = c("red", "blue"),main = "glycocholate")
MetBoxPlots(mat2use, "taurocholate",cols = c("red", "blue"),main = "taurocholate")
MetBoxPlots(mat2use, "dehydroisoandrosterone.sulfate..DHEA.S.",cols = c("red", "blue"),main = "dehydroisoandrosterone sulfate (DHEA-S)")
MetBoxPlots(mat2use, "androstenediol..3beta.17beta..disulfate..2.",cols = c("red", "blue"),main = "androstenediol (3beta,17beta) disulfate (2)")
```

Second, we can try to classify only primary and seconday tolerant recipients:
```{r, echo = FALSE}
set.seed(1)
rf_tol <- rf_tol1_tol2(df_orig = norm_data, mtry = 30, ntree = 10000)
rf_tol
```

Volcano plots between primary and secondary tolerant patients: 

```{r}
mat2use <- norm_data[which(norm_data$group!="non_tolerant"),]

res <- TwoGroup(mat2use)
VolcanoPlot(res$output[,4], res$output[,2], cexlab = 0.6)
MetBoxPlots(mat2use, "N.methylproline",cols = c("blue","green"),main = "N-methylproline")
MetBoxPlots(mat2use, "chiro.inositol",cols = c("blue","green"),main = "chiro-inositol")
MetBoxPlots(mat2use, "X1.7.dimethylurate",cols = c("blue","green"),main = "1,7-dimethylurate")
MetBoxPlots(mat2use, "X1.methylurate",cols = c("blue","green"),main = "1-methylurate")
```

## Feature Selection

### Identifying metabolites that differ between tolerant and non tolerant recipients:

Run the permutation distribution, taking demographic variables into account:
I first add the demographics information (on age and gender compatibiliry) to the data.
```{r, echo = FALSE}
names(gender_comp) <- rownames(couple_info)[c(FALSE,TRUE)]
r_gender_comp <- gender_comp[rownames(norm_data)]

names(age_recip) <- rownames(couple_info)[c(FALSE,TRUE)]
r_age_recip <- age_recip[rownames(norm_data)]

norm_data$gender_comp <- as.factor(r_gender_comp)
norm_data$age_recip <- as.numeric(r_age_recip)

norm_data_3gr <- norm_data

recip_path <- "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/v2_012020/recip/"
```


I then compute the permutation distribution for non vs tolerant recipients.
```{r, eval=FALSE, echo=FALSE}
norm_data$group <- as.character(norm_data$group)
norm_data$group[which(norm_data$group!="non_tolerant")] <- "tolerant"
norm_data$group <- as.factor(norm_data$group)

# Calculate the number of cores
no_cores <- detectCores() - 1

# Initiate cluster
cl<-makeCluster(no_cores)
 
clusterExport(cl, c("norm_data", "perm_val_LR_demo"))

Sys.time()
perm_vals <- parLapply(cl, seq_along(colnames(norm_data)[-which(colnames(norm_data) %in% c("group", "age_recip", "gender_comp"))]), function(feat){
  perm_val_LR_demo(data = norm_data, nb_perm = 1000, ind_feature = feat+1)
})

stopCluster(cl)
Sys.time()

save(perm_vals, file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/recip/perm_vals_TNT.RData")
save(norm_data, file= "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/recip/norm_data_TNT.RData")
```

 Visualise the resulting quantile values:
 In the first plot: quantile values of the models on metabolites one by one
 In the second plot: quantile values of the difference between group~ age+gender and group~ age+gender+metabolite
```{r}
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/recip/norm_data_TNT.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/recip/perm_vals_TNT.RData")
par(mfrow=c(2,1))
barplot(unlist(map(perm_vals, 1)))
barplot(unlist(map(perm_vals, 2)))

saveRDS(norm_data, file = paste0(recip_path, "norm_data_TNT.RDS"))
saveRDS(perm_vals, file = paste0(recip_path, "perm_vals_TNT.RDS"))
```

I compute the median per group for every gene, to use it later in the graphs.
```{r, echo = FALSE}
gr_medians <- norm_data %>% 
  group_by(group) %>% 
  summarize_if(is.numeric, median) %>% 
  as.data.frame()
rownames(gr_medians) <- gr_medians$group
```


#### Threshold of 0.90

Selected metabolites for the recipients (with a threshold of 0.90), after 
computing permutation distributions for every metabolite:
```{r}
# I first rearrange the nor data matrix (so that I don't have to add +1 to select features)

norm_data <- norm_data %>% 
  rownames_to_column("rn") %>% 
  dplyr::select(-group, everything()) %>% 
  column_to_rownames("rn")
```

```{r}
selected_ft_recip_qt <- select_features(perm_vals = perm_vals,
                                        norm_data = norm_data,
                                        threshold = 0.90,
                                        file_path = recip_path,
                                        file_name = "perm_val_TNT_90_thresh.xlsx") 

print(paste0(length(selected_ft_recip_qt),
             " metabolites were selected with a 0.90 threshold in the St Louis cohort."))
```

We can see which of these metabolites were also selected in the Cryostem cohort 
to separate tolerant from non tolerant recipients:
```{r, echo = FALSE}
common_features <- find_common_features(
  selected_features = selected_ft_recip_qt,
  ndata = norm_data,
  other_features_file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo_national/v2_012020/recip/perm_val_TNT_90_thresh.xlsx",
  other_norm_data_file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo_national/v2_012020/recip/norm_data_TNT.RDS",
  file_path = recip_path,
  file_name = "pctgs_sel_ft_recip_TNT_90.RDS")
```


We can see how many of these features had the same behaviour in the two cohorts 
(ie, were over or underexpressed in the same group of patients)
```{r, echo = FALSE}
common_beh_features <- find_common_behaviour_features(list_common_features = common_features,
                                                      file_path = recip_path,
                                                      common_ft_file_name = "perm_val_dir_TNT_90_thresh.xlsx",
                                                      common_beh_file_name = "perm_val_beh_TNT_90_thresh.xlsx")
common_beh_features

```


Graph of the selected metabolites that are common and have the same behaviour 
between the two cohorts:
The features that were correlated (ie expressed in similar ways among the 
recipients) in both cohorts are linked in the graph.
The features that were more expressed in the non tolerant recipients
are colored in red, while the features that were more expressed in tolerant 
recipients are colored in blue.


```{r}
gr <- plot_correlations(ft_df = common_features$local_df[,c("group",common_beh_features)],
                  ft_file_other_cohort = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo_national/v2_012020/recip/pctgs_sel_ft_recip_TNT_90.RDS",
                  compar = "TNT", pval_threshold = 0.001)
```


I save the common features in an excel file:
The excel file contains information on which features were correlated in the graph above.
It also contains, for every gene, the associated logFC, pvalue..., where the comparison 
is in non tolerant versus tolerant patients (eg, a positive Fold Change for a gene 
therefore means that the gene is overexpressed in non tolrant patients)
```{r, echo = FALSE}
export_DEstats_and_graphinfo(gr = gr,
                             common_features = common_features$common_features,
                             common_beh_features = common_beh_features,
                             norm_data = norm_data,
                             comparison = "TNT",
                             folder_path = recip_path,
                             common_ft_name = "annot_TNT_selected_ft_90_stlouis.xlsx",
                             common_beh_ft_name = "annot_TNT_selected_ft_beh_90_stlouis.xlsx")
```


We can try to build a RF model based on these common features:
```{r, echo = FALSE}
set.seed(1)
dta_tmp <- common_features$local_df
nb_features = length(common_features$common_features)
rf1 <- rf_tol_non_tol(df_orig = dta_tmp, 
                      mtry = round(sqrt(nb_features)), ntree = 1000)
rf1
```

The classification of the St Louis recipients into tolerant and non tolerant 
groups after feature selection is just as good as it already was before.


#### Including gender compatibility and age recip in the feature selection

Now that we have selected metabolites that seemed to play a role in tolerance that 
were common to both cohorts (with a threhold over 0.90), we decide to 
investigate into these metabolites to see if some of them are related to the age
of the recipients, to the gender compatibility between the donor and recipient,
to both or to none of these two causes.

I first build new models using the metabolites that were kept in the 
two cohorts as informative when comparing tolerant and non tolerant patients: 
```{r}
new_models <- lapply(seq_along(common_features$common_features), function(idx){
  dta_tmp <- norm_data[,c(common_features$common_features[idx],
                        "group", "age_recip", "gender_comp")]
  colnames(dta_tmp)[1] <- "Var"
  fit1 <- glm(group ~ Var, data=dta_tmp,trace=F, family = "binomial")
  fit2 <- glm(group ~ gender_comp + Var,
              data=dta_tmp,trace=F, family = "binomial")
  fit3 <- glm(group ~ age_recip + Var, 
              data=dta_tmp,trace=F, family = "binomial")
  fit4 <- glm(group ~ gender_comp + age_recip + Var, 
              data=dta_tmp,trace=F, family = "binomial")
  list(fit1, fit2, fit3, fit4)
})
```

```{r, eval = FALSE}
plots_gender_age(pdf_name = "../plots/metabo/recip/age_and_gender/tol_nontol_0.9.pdf",
                 norm_data = norm_data,
                 features = common_features$common_features, compar = "TNT")

```

```{r, eval = FALSE}
plots_gender_age2(pdf_name = "../plots/metabo/recip/age_and_gender/tol_nontol_0.9_behavior.pdf",
                 norm_data = norm_data,
                 features = common_beh_features, compar = "TNT",
                 excel_name = "../plots/metabo/recip/age_and_gender/tol_nontol_0.9_behavior.xlsx")

```




## Looking at differences between primary and secondary tolerant recipients

I compute the permutation distribution for primary vs secondary tolerant recipients:
```{r, eval=FALSE, echo=FALSE}
norm_data <- norm_data_3gr

norm_data <- norm_data[which(norm_data$group != "non_tolerant"),]
norm_data$group <- as.factor(as.character(norm_data$group))

# Calculate the perm_values on PRISM:
perm_vals_PRISM(norm_data, PRISM_name = "metabo_recip_prim_sec")

# Fetch the data back from PRISM
handle2 <- readRDS("handle2.rds")
perm_vals<-qsub_retrieve(handle2)
 
save(perm_vals, file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/recip/perm_vals_PS.RData")
save(norm_data, file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/recip/norm_data_PS.RData")
```

 Visualise the resulting quantile values:
 In the first plot: quantile values of the models on metabolites one by one
 In the second plot: quantile values of the difference between group~ age+gender and group~ age+gender+metabolite
```{r}
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/recip/norm_data_PS.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/recip/perm_vals_PS.RData")
par(mfrow=c(2,1))
barplot(unlist(map(perm_vals, 1)))
barplot(unlist(map(perm_vals, 2)))

saveRDS(norm_data, file = paste0(recip_path, "norm_data_PTST.RDS"))
saveRDS(perm_vals, file = paste0(recip_path, "perm_vals_PTST.RDS"))
```

Compute the median per group for every gene, to use it later in the graphs:
```{r}
gr_medians <- norm_data %>% 
  group_by(group) %>% 
  summarize_if(is.numeric, median) %>% 
  as.data.frame()
rownames(gr_medians) <- gr_medians$group
```

#### Threshold of 0.90

Selected metabolites for the recipients (with a threshold of 0.90), after 
computing permutation distributions for every metabolite:
```{r}
# I first rearrange the nor data matrix (so that I don't have to add +1 to select features)

norm_data <- norm_data %>% 
  rownames_to_column("rn") %>% 
  dplyr::select(-group, everything()) %>% 
  column_to_rownames("rn")
```

```{r}
selected_ft_recip_qt <- select_features(perm_vals = perm_vals,
                                        norm_data = norm_data,
                                        threshold = 0.90,
                                        file_path = recip_path,
                                        file_name = "perm_val_PTST_90_thresh.xlsx") 

print(paste0(length(selected_ft_recip_qt),
             " metabolites were selected with a 0.90 threshold in the St Louis cohort."))
```

We can see which of these metabolites were also selected in the Cryostem cohort 
to separate tolerant from non tolerant recipients:
```{r, echo = FALSE}
common_features <- find_common_features(
  selected_features = selected_ft_recip_qt,
  ndata = norm_data,
  other_features_file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo_national/v2_012020/recip/perm_val_PTST_90_thresh.xlsx",
  other_norm_data_file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo_national/v2_012020/recip/norm_data_PTST.RDS",
  file_path = recip_path,
  file_name = "pctgs_sel_ft_recip_PTST_90.RDS")
```


We can see how many of these features had the same behaviour in the two cohorts 
(ie, were over or underexpressed in the same group of patients)
```{r, echo = FALSE}
common_beh_features <- find_common_behaviour_features(list_common_features = common_features,
                                                      file_path = recip_path,
                                                      common_ft_file_name = "perm_val_dir_PTST_90_thresh.xlsx",
                                                      common_beh_file_name = "perm_val_beh_PTST_90_thresh.xlsx")
common_beh_features

```


Graph of the selected metabolites that are common between the two cohorts:
The features that were correlated (ie expressed in similar ways among the 
recipients) are linked in the graph.
The features that were more expressed in the non tolerant St Louis recipients
are colored in red, while the features that were more expressed in tolerant 
recipients are colored in blue.
```{r, echo = FALSE, eval = FALSE}
gr <- plot_correlations(common_features$local_df, compar = "PS")
```

I save the common features in an excel file:
The excel file contains information on which features were correlated in the graph above.
It also contains, for every gene, the associated logFC, pvalue..., where the comparison 
is in non tolerant versus tolerant patients (eg, a positive Fold Change for a gene 
therefore means that the gene is overexpressed in non tolrant patients)
```{r, echo = FALSE, eval = FALSE}
export_DEstats_and_graphinfo(gr = gr,
                             common_features = common_features$common_features,
                             common_beh_features = common_beh_features,
                             norm_data = norm_data,
                             comparison = "PTST",
                             folder_path = recip_path,
                             common_ft_name = "annot_PTST_selected_ft_90_stlouis.xlsx",
                             common_beh_ft_name = "annot_PTST_selected_ft_beh_90_stlouis.xlsx")
```


Comparison of all metabolites of the 2 cohorts:

```{r}
metabo_cor_2_cohorts_LR(model_stat1="~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo_national/recip/perm_vals_PS.RData",
                        norm_data1 = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo_national/recip/norm_data_PS.RData",
                        model_stat2 = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/recip/perm_vals_PS.RData", 
                        norm_data2 = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/recip/norm_data_PS.RData", 
                        stat_of_interest = 1, 
                        meta_metabo = meta_metabo)
```


#### Including gender compatibility and age recip in the feature selection

Now that we have selected metabolites that seemed to play a role in tolerance that 
were common to both cohorts (with a threhold over 0.90), we decide to 
investigate into these metabolites to see if some of them are related to the age
of the recipients, to the gender compatibility between the donor and recipient,
to both or to none of these two causes.

I first build new models using the metabolites that were kept in the 
two cohorts as informative when comparing primary and secondary tolerant patients: 
```{r}
new_models <- lapply(seq_along(common_features$common_features), function(idx){
  dta_tmp <- norm_data[,c(common_features$common_features[idx],
                        "group", "age_recip", "gender_comp")]
  colnames(dta_tmp)[1] <- "Var"
  fit1 <- glm(group ~ Var, data=dta_tmp,trace=F, family = "binomial")
  fit2 <- glm(group ~ gender_comp + Var,
              data=dta_tmp,trace=F, family = "binomial")
  fit3 <- glm(group ~ age_recip + Var, 
              data=dta_tmp,trace=F, family = "binomial")
  fit4 <- glm(group ~ gender_comp + age_recip + Var, 
              data=dta_tmp,trace=F, family = "binomial")
  list(fit1, fit2, fit3, fit4)
})
```

```{r}
plots_gender_age(pdf_name = "../plots/metabo/recip/age_and_gender/prim_sec_0.9.pdf",
                 norm_data = norm_data,
                 features = common_features$common_features, compar = "PTST")

```

```{r}
plots_gender_age2(pdf_name = "../plots/metabo/recip/age_and_gender/prim_sec_0.9_behavior.pdf",
                 norm_data = norm_data,
                 features = common_beh_features, compar = "PTST",
                 excel_name = "../plots/metabo/recip/age_and_gender/prim_sec_0.9_behavior.xlsx")

```



# Analysis on the donors only :

Load in the data :
```{r}
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/donors/norm_data.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/donors/meta_metabo.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/donors/big_mat.RData")
```

We can perform a principal components analysis on the donors to see if we
would already see some structure in the data:
```{r}
pca_met <- prcomp(norm_data %>% dplyr::select(-"Group"))
```

It looks like the two first principal components are by far the most informative: 
```{r}
plot(pca_met)
```

```{r, echo = FALSE}
samp_donor <- samp_rd %>% 
  dplyr::filter(grepl("D", Id.Cryostem.R)) %>% 
  dplyr::filter(!is.na(METABONAME))
pca_2plot <- as.data.frame(pca_met$x, stringsAsFactors = F) %>% 
  dplyr::select(PC1, PC2) %>% 
  rownames_to_column("METABONAME") %>% 
  left_join(samp_donor, by = "METABONAME")
  
ggplot(pca_2plot, aes(x = PC1, y = PC2, color = as.factor(GROUP))) +
  geom_point() +
  geom_text(aes(label=Id.Cryostem.R),hjust=0, vjust=0)
ggplot(pca_2plot, aes(x = PC1, y = PC2, color = as.factor(CMVStatus))) +
  geom_point() +
  geom_text(aes(label=Id.Cryostem.R),hjust=0, vjust=0) +
  scale_color_manual(breaks = c("0", "1"),
                     values = c("white", "black"))

```
I plot the FCS names of the donors, for easier comparison of the metabolomics
data with the results found in the CyTOF data.
The groups seem to be quite mixed in the PCA.
I also colored the donors per CMV status, but there doesn't seem to be a 
CMV positive group, as opposed to what was observed in the CyTOF data.


We can try to run random forest models on the donors, before applying any 
feature selection :
But it seems like the metabolomics data isn't sufficient to classify the donors 
leading to tolerance or non tolerance
```{r, echo = FALSE}
colnames(norm_data) <- make.names(colnames(norm_data))

set.seed(1)
rf_donor <- randomForest::randomForest(Group~., norm_data, mtry = 40)
rf_donor
```

We can try an easier classification problem: non tolerant vs tolerant patients.
But it seems like the metabolomics data doesn't allow us to classify the donors.

```{r, echo=FALSE}
colnames(norm_data)[1] <- "group"
norm_data$group <- tolower(norm_data$group)

set.seed(1)
rf1d <- rf_tol_non_tol(df_orig = norm_data, mtry = 30, ntree = 10000)
rf1d
```

It seems like the metabolomics daat isn't sufficient to classify the donors as
primary or seconday tolerant neither:
```{r, echo = FALSE}
set.seed(1)
rfd_tol <- rf_tol1_tol2(df_orig = norm_data, mtry = 30, ntree = 10000)
rfd_tol
```

## Feature selection

### Differences in metabolites between donors leading to tolerance or non tolerance 

Run the permutation distribution, taking demographic variables into account:
I first add the demographics info to the norm_data:
```{r, echo = FALSE}
names(gender_comp) <- rownames(couple_info)[c(TRUE,FALSE)]
d_gender_comp <- gender_comp[rownames(norm_data)]

names(age_recip) <- rownames(couple_info)[c(TRUE,FALSE)]
d_age_recip <- age_recip[rownames(norm_data)]

norm_data$gender_comp <- as.factor(d_gender_comp)
norm_data$age_recip <- as.numeric(d_age_recip)

norm_data_3gr <- norm_data

donor_path <- "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/v2_012020/donors/"
```

I then compute the permutation distribution for non vs tolerance.
```{r, eval=FALSE, echo=FALSE}
norm_data$group <- as.character(norm_data$group)
norm_data$group[which(norm_data$group!="non_tolerant")] <- "tolerant"
norm_data$group <- as.factor(norm_data$group)

# Calculate the perm_values on PRISM:
perm_vals_PRISM(norm_data, PRISM_name = "metabo_recip_prim_sec")

# Fetch the data back from PRISM
handle2 <- readRDS("../../handle_louis_donors_TNT.rds")
perm_vals<-qsub_retrieve(handle2)
 
save(perm_vals, file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/donors/perm_vals_TNT.RData")
save(norm_data, file= "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/donors/norm_data_TNT.RData")
```

 Visualise the resulting quantile values:
```{r}
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/donors/perm_vals_TNT.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/donors/norm_data_TNT.RData")
par(mfrow=c(2,1))
barplot(unlist(map(perm_vals, 1)))
barplot(unlist(map(perm_vals, 2)))

saveRDS(norm_data, file = paste0(donor_path, "norm_data_TNT.RDS"))
saveRDS(perm_vals, file = paste0(donor_path, "perm_vals_TNT.RDS"))
```

Compute the median per group for every gene, to use it later in the graphs:
```{r}
gr_medians <- norm_data %>% 
  group_by(group) %>% 
  summarize_if(is.numeric, median) %>% 
  as.data.frame()
rownames(gr_medians) <- gr_medians$group
```


#### Threshold of 0.90

```{r}
# I first rearrange the nor data matrix (so that I don't have to add +1 to select features)

norm_data <- norm_data %>% 
  rownames_to_column("rn") %>% 
  dplyr::select(-group, everything()) %>% 
  column_to_rownames("rn")
```

Selected metabolites for the donors, after computing permutation distributions for every metabolite:
```{r, echo = FALSE}
selected_ft_donor_qt <- select_features(perm_vals = perm_vals,
                                        norm_data = norm_data,
                                        threshold = 0.90,
                                        file_path = donor_path,
                                        file_name = "perm_val_TNT_90_thresh.xlsx") 

print(paste0(length(selected_ft_donor_qt),
             " metabolites were selected with a 0.90 threshold in the St Louis cohort."))
```

We can see which of these metabolites were also selected in the St Louis cohort 
to separate tolerant from non tolerant recipients:
```{r, echo = FALSE}
common_features <- find_common_features(
  selected_features = selected_ft_donor_qt,
  ndata = norm_data,
  other_features_file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo_national/v2_012020/donors/perm_val_TNT_90_thresh.xlsx",
  other_norm_data_file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo_national/v2_012020/donors/norm_data_TNT.RDS",
  file_path = donor_path,
  file_name = "pctgs_sel_ft_donors_TNT_90.RDS")
```

We can see how many of these features had the same behaviour in the two cohorts 
(ie, were over or underexpressed in the same group of patients)
```{r, echo = FALSE}
common_beh_features <- find_common_behaviour_features(list_common_features = common_features,
                                                      file_path = donor_path,
                                                      common_ft_file_name = "perm_val_dir_TNT_90_thresh.xlsx",
                                                      common_beh_file_name = "perm_val_beh_TNT_90_thresh.xlsx")
common_beh_features

```

Graph of the selected metabolites that are common between the two cohorts:
The features that were correlated (ie expressed in similar ways among the 
recipients) are linked in the graph.
The features that were more expressed in the non tolerant St Louis recipients
are colored in red, while the features that were more expressed in tolerant 
recipients are colored in blue.
```{r, echo = FALSE, eval = FALSE}
gr <- plot_correlations(common_features$local_df, compar = "TNT")
```

I save the common features in an excel file:
The excel file contains information on which features were correlated in the graph above.
It also contains, for every gene, the associated logFC, pvalue..., where the comparison 
is in non tolerant versus tolerant patients (eg, a positive Fold Change for a gene 
therefore means that the gene is overexpressed in non tolrant patients)
```{r, echo = FALSE, eval = FALSE}
export_DEstats_and_graphinfo(gr = gr,
                             common_features = common_features$common_features,
                             common_beh_features = common_beh_features,
                             norm_data = norm_data,
                             comparison = "TNT",
                             folder_path = donor_path,
                             common_ft_name = "annot_TNT_selected_ft_90_cryostem.xlsx",
                             common_beh_ft_name = "annot_TNT_selected_ft_beh_90_cryostem.xlsx")
```


We can try to build a RF model based on these common features:
```{r, echo = FALSE}
set.seed(1)
dta_tmp <- common_features$local_df
nb_features = length(common_features$common_features)
rf1 <- rf_tol_non_tol(df_orig = dta_tmp, 
                      mtry = round(sqrt(nb_features)), ntree = 1000)
rf1
```

#### Including gender compatibility and age recip in the feature selection

Now that we have selected metabolites that seemed to play a role in tolerance that 
were common to both cohorts (with a threhold over 0.90), we decide to 
investigate into these metabolites to see if some of them are related to the age
of the recipients, to the gender compatibility between the donor and recipient,
to both or to none of these two causes.

I first build new models using the metabolites that were kept in the 
two cohorts as informative when comparing tolerant and non tolerant patients: 
```{r}
new_models <- lapply(seq_along(common_features$common_features), function(idx){
  dta_tmp <- norm_data[,c(common_features$common_features[idx],
                        "group", "age_recip", "gender_comp")]
  colnames(dta_tmp)[1] <- "Var"
  fit1 <- glm(group ~ Var, data=dta_tmp,trace=F, family = "binomial")
  fit2 <- glm(group ~ gender_comp + Var,
              data=dta_tmp,trace=F, family = "binomial")
  fit3 <- glm(group ~ age_recip + Var, 
              data=dta_tmp,trace=F, family = "binomial")
  fit4 <- glm(group ~ gender_comp + age_recip + Var, 
              data=dta_tmp,trace=F, family = "binomial")
  list(fit1, fit2, fit3, fit4)
})
```

```{r, eval = FALSE}
plots_gender_age(pdf_name = "../plots/metabo/donors/age_and_gender/tol_nontol_0.9.pdf",
                 norm_data = norm_data,
                 features = common_features$common_features, compar = "TNT")

```

```{r, eval = FALSE}
plots_gender_age(pdf_name = "../plots/metabo/donors/age_and_gender/tol_nontol_0.9_behavior.pdf",
                 norm_data = norm_data,
                 features = common_beh_features, compar = "TNT")

```

### Looking at differences between primary and secondary tolerant donors

I compute the permutation distribution for primary vs secondary tolerant donors:
```{r, eval=FALSE, echo=FALSE}
norm_data <- norm_data_3gr

norm_data <- norm_data[which(norm_data$group != "non_tolerant"),]
norm_data$group <- as.factor(as.character(norm_data$group))

# Calculate the perm_values on PRISM:
perm_vals_PRISM(norm_data, PRISM_name = "metabo_donors_prim_sec")

# Fetch the data back from PRISM
handle3 <- readRDS("handle_louis_donors_TNT.rds")
perm_vals<-qsub_retrieve(handle3)
 
save(perm_vals, file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/donors/perm_vals_PS.RData")
save(norm_data, file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/donors/norm_data_PS.RData")
```

Visualise the resulting quantile values:
 In the first plot: quantile values of the models on metabolites one by one
 In the second plot: quantile values of the difference between group~ age+gender and group~ age+gender+metabolite
```{r}
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/donors/norm_data_PS.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/donors/perm_vals_PS.RData")
par(mfrow=c(2,1))
barplot(unlist(map(perm_vals, 1)))
barplot(unlist(map(perm_vals, 2)))

saveRDS(norm_data, file = paste0(donor_path, "norm_data_PTST.RDS"))
saveRDS(perm_vals, file = paste0(donor_path, "perm_vals_PTST.RDS"))
```

Compute the median per group for every gene, to use it later in the graphs:
```{r}
gr_medians <- norm_data %>% 
  group_by(group) %>% 
  summarize_if(is.numeric, median) %>% 
  as.data.frame()
rownames(gr_medians) <- gr_medians$group
```


#### Threshold of 0.90

```{r}
# I first rearrange the nor data matrix (so that I don't have to add +1 to select features)

norm_data <- norm_data %>% 
  rownames_to_column("rn") %>% 
  dplyr::select(-group, everything()) %>% 
  column_to_rownames("rn")
```

Selected metabolites for the donors, after computing permutation distributions for every metabolite:
```{r, echo = FALSE}
selected_ft_donor_qt <- select_features(perm_vals = perm_vals,
                                        norm_data = norm_data,
                                        threshold = 0.90,
                                        file_path = donor_path,
                                        file_name = "perm_val_PTST_90_thresh.xlsx") 

print(paste0(length(selected_ft_donor_qt),
             " metabolites were selected with a 0.90 threshold in the St Louis cohort."))
```

We can see which of these metabolites were also selected in the Cryostem cohort 
to separate primary from secondary tolerant donors:
```{r, echo = FALSE}
common_features <- find_common_features(
  selected_features = selected_ft_donor_qt,
  ndata = norm_data,
  other_features_file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo_national/v2_012020/donors/perm_val_PTST_90_thresh.xlsx",
  other_norm_data_file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo_national/v2_012020/donors/norm_data_PTST.RDS",
  file_path = donor_path,
  file_name = "pctgs_sel_ft_donors_PTST_90.RDS")
```

We can see how many of these features had the same behaviour in the two cohorts 
(ie, were over or underexpressed in the same group of patients)
```{r, echo = FALSE}
common_beh_features <- find_common_behaviour_features(list_common_features = common_features,
                                                      file_path = donor_path,
                                                      common_ft_file_name = "perm_val_dir_PTST_90_thresh.xlsx",
                                                      common_beh_file_name = "perm_val_beh_PTST_90_thresh.xlsx")
common_beh_features

```

Graph of the selected metabolites that are common between the two cohorts:
The features that were correlated (ie expressed in similar ways among the 
recipients) are linked in the graph.
The features that were more expressed in the non tolerant St Louis recipients
are colored in red, while the features that were more expressed in tolerant 
recipients are colored in blue.
```{r, echo = FALSE, eval = FALSE}
gr <- plot_correlations(common_features$local_df, compar = "PS")
```

I save the common features in an excel file:
The excel file contains information on which features were correlated in the graph above.
It also contains, for every gene, the associated logFC, pvalue..., where the comparison 
is in non tolerant versus tolerant patients (eg, a positive Fold Change for a gene 
therefore means that the gene is overexpressed in non tolrant patients)
```{r, echo = FALSE, eval = FALSE}
export_DEstats_and_graphinfo(gr = gr,
                             common_features = common_features$common_features,
                             common_beh_features = common_beh_features,
                             norm_data = norm_data,
                             comparison = "PTST",
                             folder_path = donor_path,
                             common_ft_name = "annot_PTST_selected_ft_90_cryostem.xlsx",
                             common_beh_ft_name = "annot_PTST_selected_ft_beh_90_cryostem.xlsx")
```


#### Including gender compatibility and age recip in the feature selection

Now that we have selected metabolites that seemed to play a role in tolerance that 
were common to both cohorts (with a threhold over 0.90), we decide to 
investigate into these metabolites to see if some of them are related to the age
of the recipients, to the gender compatibility between the donor and recipient,
to both or to none of these two causes.

I first build new models using the metabolites that were kept in the 
two cohorts as informative when comparing tolerant and non tolerant patients: 
```{r}
new_models <- lapply(seq_along(common_features$common_features), function(idx){
  dta_tmp <- norm_data[,c(common_features$common_features[idx],
                        "group", "age_recip", "gender_comp")]
  colnames(dta_tmp)[1] <- "Var"
  fit1 <- glm(group ~ Var, data=dta_tmp,trace=F, family = "binomial")
  fit2 <- glm(group ~ gender_comp + Var,
              data=dta_tmp,trace=F, family = "binomial")
  fit3 <- glm(group ~ age_recip + Var, 
              data=dta_tmp,trace=F, family = "binomial")
  fit4 <- glm(group ~ gender_comp + age_recip + Var, 
              data=dta_tmp,trace=F, family = "binomial")
  list(fit1, fit2, fit3, fit4)
})
```

```{r, eval = FALSE}
plots_gender_age(pdf_name = "../plots/metabo/donors/age_and_gender/prim_sec_0.9.pdf",
                 norm_data = norm_data,
                 features = common_features$common_features, compar = "PTST")

```

```{r, eval = FALSE}
plots_gender_age(pdf_name = "../plots/metabo/donors/age_and_gender/prim_sec_0.9_behavior.pdf",
                 norm_data = norm_data,
                 features = common_beh_features, compar = "PTST")

```


# Analysis on the donors - recipients :

In order to investigate into the differences between the recipients' metabolite profile compared to the original profile of their donor, I'm running the same analysis on the donors-recipients (matched per couple of course)

```{r, results = 'hide', echo = FALSE}
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/r&d/logdata.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/r&d/meta_metabo.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/r&d/big_mat.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/r&d/rd_meta.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/r&d/norm_data.RData")
samp_rd <- read.xlsx("~/Documents/VIB/Projects/Integrative_Paris/Local_cohort/Data synthesis local cohort Saint-Louis 17012019.xlsx")

samp_rd <- samp_rd %>%
  mutate(DOB = as.Date(DOB, format = "%d.%m.%Y"),
         DOG = as.Date(DOG, format = "%d.%m.%Y"))

vars2rm <- colnames(rd_meta)[-c(4, 10)]
big_mat2 <- big_mat %>%
  group_by(COUPLENUMBER) %>%
  dplyr::select(-vars2rm)

saveRDS(big_mat2, "../data/metabo/compar_donors_recipients/mat_pheno_funct_donors_and_recipients.RDS")

subst <- big_mat2 %>%
  summarise_if(is.numeric, ~.[1]-.[2])

samp_rd_subst <- samp_rd[which(samp_rd$COUPLENUMBER %in% subst$COUPLENUMBER),] %>%
  arrange(COUPLENUMBER) %>%
  dplyr::select(c("GROUP", "COUPLENUMBER")) %>%
  unique()

subst <- subst %>%
  mutate("couple" = paste0("couple_",COUPLENUMBER),
         "group" = samp_rd_subst$GROUP) %>%
  column_to_rownames("couple") %>%
  dplyr::select (-"COUPLENUMBER")

subst <- subst[c(541, 1:540)]

colnames(subst) <- make.names(colnames(subst))
colnames(subst)[-1] <- paste0("subst_", colnames(subst))[-1]

save(samp_rd, file = "../data/metabo/r&d/samp_rd.RData")
```

We can apply a principal components analysis to see if there is some structure
in the data that can already be seen:
```{r, echo = FALSE}
toplot <- big_mat2 %>% 
  dplyr::ungroup() %>% 
  dplyr::select(-Group, -COUPLENUMBER, -METABONAME)
pca <- prcomp(as.matrix(toplot))

pca_2plot <- as.data.frame(pca$x, stringsAsFactors = F) %>% 
  dplyr::select(PC1, PC2) %>% 
  mutate(METABONAME = rownames(pca$x)) %>% 
  left_join(samp_rd, by = "METABONAME")
ggplot(pca_2plot, aes(x = PC1, y = PC2, col = as.factor(GROUP), label = Id.Cryostem.R)) + 
  geom_point() +
  geom_text(aes(label=Id.Cryostem.R),hjust=0, vjust=0)
```

In the following PCA plot, we plot the recipients as black dots, the donors as 
white dots, and we link donors and recipients that belong to same a couple by
a line of the color of their group.
```{r, echo = FALSE}
big_mat2$Group <- tolower(big_mat2$Group)
plot(pca$x)
distances = c()
for (i in names(table(big_mat2$COUPLENUMBER))){
  group_status <- big_mat2$Group[which(big_mat2$COUPLENUMBER==i)]
  pt_coord <- pca$x[as.numeric(rownames(big_mat2)[which(big_mat2$COUPLENUMBER==i)]),c(1:2)]
  if(group_status[1]=="non_tolerant"){
    lines(pt_coord,col="red")
    points(pt_coord[1,1], pt_coord[1,2], pch = 19)
  } else if(group_status[1]=="primary_tolerant"){
    lines(pt_coord,col="green")
    points(pt_coord[1,1], pt_coord[1,2], pch = 19)
  } else {
    lines(pt_coord,col="blue")
    points(pt_coord[1,1], pt_coord[1,2], pch = 19)
  }
  distances = c(distances, sqrt((pt_coord[2,1]-pt_coord[1,1])^2 + (pt_coord[2,2]-pt_coord[1,2])^2))
}
```

It looks like, in the metabolomics data of the St Louis cohort, the distances 
between non tolerant donors and recipients are higher than the distances between 
primary or secondary tolerant donors and recipients. This is similar to what we
had observed in the CyTOF data of these same patients.
```{r}

list_couples <- names(table(big_mat2$COUPLENUMBER))
names(distances) <- paste0("couple_",list_couples)
couple_dist_matrix <- big_mat2[,c("COUPLENUMBER", "Group")] %>% arrange(COUPLENUMBER) %>% unique()
couple_dist_matrix$Group <- as.factor(couple_dist_matrix$Group)
dis_colors <- c("red","green","blue")[couple_dist_matrix$Group]
order_dis <- order(distances)

plot(distances[order_dis], col = dis_colors[order_dis], pch=19,
     main = "Distance between donor and recipient from same couple",
     ylab = "Distance D/R", xaxt = "n", xlab = "")
axis(1, at=seq_along(list_couples), labels=FALSE)
text(x=seq_along(list_couples), y=par()$usr[3]-0.1*(par()$usr[4]-par()$usr[3]),
     labels=names(distances[order_dis]), srt=45, adj=1, xpd=TRUE, cex = .7)
legend("topleft", c("non_tolerant","primary_tolerant","secondary_tolerant"),
       col = c("red","green","blue"), pch = 19)
```

I can already try to classify the donors - recipients based on all the metabolites:
```{r}
subst$group <- as.factor(subst$group)
colnames(subst) <- make.names(colnames(subst))

set.seed(1)
rf_subst <- randomForest::randomForest(group~., subst, mtry = 40)
rf_subst
```

Trying to classify between non tolerant and tolerant patients:

```{r, echo=FALSE}
subst$group <- tolower(subst$group)

saveRDS(subst, "../data/metabo/compar_donors_recipients/mat_all_patients.RDS")

set.seed(1)
rf1_subst <- rf_tol_non_tol(df_orig = subst, mtry = 30, ntree = 10000)
rf1_subst
```
It seems like some metabolites might help to differentiate between tolerant
and non tolerant couples.
Trying to classify only primary and seconday tolerant recipients:
```{r, echo = FALSE}
set.seed(1)
rf_subst_tol <- rf_tol1_tol2(df_orig = subst, mtry = 30, ntree = 10000)
rf_subst_tol
```

But the information in the metabolites seems unsufficient to classify primary
and secondary couples.

## Feature selection

### Investigating into metabolites that mainly differ between tolerant and non tolerant couples:

I first add the demographics info to the couple matrix:
```{r, echo = FALSE}
names(gender_comp) <- paste0("couple_",couple_info$COUPLENUMBER[c(FALSE,TRUE)])
dr_gender_comp <- gender_comp[rownames(subst)]

names(age_recip) <- paste0("couple_",couple_info$COUPLENUMBER[c(FALSE,TRUE)])
dr_age_recip <- age_recip[rownames(subst)]

subst$gender_comp <- as.factor(dr_gender_comp)
subst$age_recip <- as.numeric(dr_age_recip)

norm_data <- subst
```

I then compute the permutation distribution for non vs tolerant recipients.
```{r, eval=FALSE, echo=FALSE}
norm_data$group <- as.character(norm_data$group)
norm_data$group[which(norm_data$group!="non_tolerant")] <- "tolerant"
norm_data$group <- as.factor(norm_data$group)

perm_vals_PRISM(norm_data = norm_data, PRISM_name = "bla")

perm_vals <- qsub_retrieve(handle3)

save(perm_vals, file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/r&d/perm_vals_TNT.RData")
save(norm_data, file= "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/r&d/norm_data_TNT.RData")
```

Visualise the resulting quantile values:
```{r}
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/r&d/perm_vals_TNT.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/r&d/norm_data_TNT.RData")
par(mfrow=c(2,1))
barplot(unlist(map(perm_vals, 1)))
barplot(unlist(map(perm_vals, 2)))
```

Compute the median per group for every gene, to use it later in the graphs:
```{r}
gr_medians <- norm_data %>%
  group_by(group) %>%
  summarize_if(is.numeric, median) %>%
  as.data.frame()
rownames(gr_medians) <- gr_medians$group
```

#### Threshold of 0.95

Selected metabolites for the couples, with a threshold on 0.95:
```{r}
qt <- unlist(map(perm_vals, 1))
densityplot(qt)
selected_metabolites_rd_qt <- colnames(norm_data)[which(qt>.95)+1]
write.xlsx(selected_metabolites_rd_qt, file = "../data/metabo/r&d/perm_val_TNT_95_thresh.xlsx")
# selected_metabolites_rd_qt
print(paste0(length(selected_metabolites_rd_qt),
             " metabolites were selected with a 0.95 threshold in the St Louis cohort."))
```

Which of these metabolites were common in the cryostem cohort?
```{r}
sel_cryo <- read.xlsx("../data/metabo_national/r&d/perm_val_TNT_95_thresh.xlsx", colNames = FALSE)
sel_common <- which(selected_metabolites_rd_qt %in% sel_cryo$X1)
length(sel_common)
sel_com_names <- selected_metabolites_rd_qt[sel_common]
sel_com_pretty_names <- gsub("subst_", "", sel_com_names)
sel_com_pretty_names 
```

```{r, echo = FALSE}
dir <- lapply(seq_len(length(sel_common)), function(idx){
  gene <- selected_metabolites_rd_qt[sel_common[idx]]
  overexp <- rownames(gr_medians)[which.is.max(gr_medians[gene][,1])]
  list(gene, overexp)
})
dir_genes <- do.call(rbind, dir)
  write.xlsx(dir_genes, file = "../data/metabo/r&d/perm_val_dir_TNT_95_thresh.xlsx")
```

I save these common metabolites:
```{r}
metabo_ft_sel_dr_TNT_95 <- norm_data[,c("group", selected_metabolites_rd_qt[sel_common])]
save(metabo_ft_sel_dr_TNT_95, 
     file = "../data/metabo/r&d/metabo_ft_sel_dr_TNT_95.RData")
write.xlsx(sel_com_pretty_names, file = "../data/metabo/r&d/excel_files_selected/metabo_ft_sel_dr_TNT_95.xlsx")
```

We can try to build a RF model based on the common features:
```{r, echo = FALSE}
set.seed(1)
nb_features = ncol(metabo_ft_sel_dr_TNT_95)-1
rf1 <- rf_tol_non_tol(df_orig = metabo_ft_sel_dr_TNT_95, 
                      mtry = round(sqrt(nb_features)), ntree = 10000)
rf1
```
<!-- Visualising how these features change at the couple level: -->
<!-- One plot is generated for every metabolite that was common in both cohorts. -->
<!-- In these plots, the expression of the metabolite in the recipients is shown on  -->
<!-- the xaxis, while the difference of eexpression D-R is shown on the yaxis. -->
<!-- The tolerant couples are in red, the non tolerant in black.  -->

<!-- If a trend is observed on the xaxis (ex: all red points on the right, all black  -->
<!-- ones on the left), it means that the expression of this metabolites highly  -->
<!-- differs in the recipients. -->

<!-- If a trend is observed on the yaxis (ex: all red points at the top, all black  -->
<!-- ones at the bottom), it means that the meabolite was not expressed equally in  -->
<!-- the donors and recipients of the same couple (in the example of red points at -->
<!-- the top, it would mean that the metabolite was overexpressed in the tolerant -->
<!-- donors). -->
<!-- ```{r} -->
<!-- norm_data_louis <- norm_data -->
<!-- couple_metabolites <- norm_data[,sel_com_names] -->
<!-- couple_group <- norm_data$group -->

<!-- load("../data/metabo/recip/norm_data_TNT.RData") -->
<!-- common_metabolites <- colnames(norm_data)[which(colnames(norm_data) %in% sel_com_pretty_names)] -->
<!-- recip_metabolites <- norm_data[,common_metabolites] -->
<!-- couplenb_in_recip <- couple_info[rownames(recip_metabolites),] %>%  -->
<!--   rownames_to_column("recip_names") %>%  -->
<!--   arrange(COUPLENUMBER) -->

<!-- recip_metabolites <- recip_metabolites[couplenb_in_recip$recip_names,] -->

<!-- colnames(couple_metabolites) <-  sel_com_pretty_names -->
<!-- couple_metabolites <- couple_metabolites[,common_metabolites] -->

<!-- for(i in seq_along(common_metabolites)){ -->
<!--   plot(x = recip_metabolites[,i], y = couple_metabolites[,i], -->
<!--      xlab = paste0("expression of ", colnames(recip_metabolites)[i], " in recipients"), -->
<!--      ylab = "Donors - Recipients") -->
<!--   abline(h = 0, col = "red") -->
<!--   points(x = recip_metabolites[,i],  -->
<!--         y = couple_metabolites[,i], -->
<!--         col = as.factor(couple_group), -->
<!--         pch = 19) -->
<!-- } -->

<!-- norm_data <- norm_data_louis -->

<!-- ``` -->

#### Threshold of 0.90

Selected metabolites for the couples, with a threshold on 0.95:
```{r}
qt <- unlist(map(perm_vals, 1))
densityplot(qt)
selected_metabolites_rd_qt <- colnames(norm_data)[which(qt>.90)+1]
write.xlsx(selected_metabolites_rd_qt, file = "../data/metabo/r&d/perm_val_TNT_90_thresh.xlsx")
# selected_metabolites_rd_qt
print(paste0(length(selected_metabolites_rd_qt),
             " metabolites were selected with a 0.95 threshold in the St Louis cohort."))
```

Which of these metabolites were common in the cryostem cohort?
```{r}
sel_cryo <- read.xlsx("../data/metabo_national/r&d/perm_val_TNT_90_thresh.xlsx", colNames = FALSE)
sel_common <- which(selected_metabolites_rd_qt %in% sel_cryo$X1)
length(sel_common)
sel_com_names <- selected_metabolites_rd_qt[sel_common]
sel_com_names
```

Save these common features:
```{r}
metabo_ft_sel_rd_TNT_90 <- norm_data[, c("group", sel_com_names)]
save(metabo_ft_sel_rd_TNT_90,
     file = "../data/metabo/r&d/metabo_ft_sel_rd_TNT_90.RData")
write.xlsx(sel_com_names, file = "../data/metabo/r&d/excel_files_selected/metabo_ft_sel_donor_TNT_90.xlsx")
```

```{r, echo = FALSE}
dir <- lapply(seq_len(length(sel_common)), function(idx){
  gene <- selected_metabolites_rd_qt[sel_common[idx]]
  overexp <- rownames(gr_medians)[which.is.max(gr_medians[gene][,1])]
  list(gene, overexp)
})
dir_genes <- do.call(rbind, dir)
write.xlsx(dir_genes, file = "../data/metabo/r&d/perm_val_dir_TNT_90_thresh.xlsx")
```

Plot the graph of these selected metabolites colored based on the groups where the metabolites are most expressed:
```{r}
correlations <- norm_data[,sel_com_names] %>%
  as.matrix %>%
  cor %>%
  as.data.frame %>%
  rownames_to_column(var = 'var1') %>%
  gather(var2, value, -var1) %>%
  dplyr::filter(var1 < var2)

correlated_features <- correlations %>%
  dplyr::filter(value > 0.7)
gr <- graph_from_data_frame(correlated_features, directed = FALSE, vertices=sel_com_names)
nodes <- get.vertex.attribute(gr)
color_nodes <- rep("red", length(nodes$name))

medians <- gr_medians[,nodes$name]
for (gene in seq_along(colnames(medians))){
  if (medians["tolerant", gene] == max(medians[, gene])){
    color_nodes[gene] <- "blue"
  }
}

set.seed(1)

plot(gr, vertex.size = 7, vertex.label.cex = .5, edge.width = (E(gr)$value - .7) * 20,
     vertex.color = color_nodes)

```

Now that we have identified features that are informative in both cohorts to 
classify tolerant from non tolerant couples, we can try to use them to build a 
model to classify the couples of the St Louis cohort:
```{r}
colnames(norm_data) <- make.names(colnames(norm_data))
set.seed(1)
rf1 <- rf_tol_non_tol(df_orig = norm_data[,c("group", make.names(sel_com_names))], ntree = 1000, package_2use = "ranger")
rf1$confusion.matrix
paste0("prediction error: ", rf1$prediction.error*100)
```

We can try to build a RF model based on the common features that had a similar
behaviour between the two cohorts:
```{r, echo = FALSE}
selb <- read.xlsx("../data/metabo/r&d/perm_val_beh_TNT_90_thresh.xlsx")
set.seed(1)
nb_features = length(selb$sel_beh)
rf_d <- ranger::ranger(group~., norm_data[,c("group", as.character(selb$sel_beh))], 
                       mtry = round(sqrt(nb_features)), num.trees = 1000,
                       importance = "impurity")
rf_d$confusion.matrix
paste0("prediction error: ", rf_d$prediction.error*100)
```

But this doesn't seem to improve the classification

### Including age and gender in the analysis 

Now that we have selected features that seemed to play a role in tolerance that 
were common to both cohorts (with a threhold over 0.90), we decide to 
investigate into these features to see if some of them are related to the age
of the recipients, to the gender compatibility between the donor and recipient,
to both or to none of these two causes.

I first build new models using the features that were kept in the 
two cohorts as informative when comparing tolerant and non tolerant patients: 
```{r}
new_models <- lapply(seq_along(make.names(sel_com_names)), function(idx){
  dta_tmp <- norm_data[,c(make.names(sel_com_names)[idx],
                        "group", "age_recip", "gender_comp")]
  colnames(dta_tmp)[1] <- "Var"
  fit1 <- glm(group ~ Var, data=dta_tmp,trace=F, family = "binomial")
  fit2 <- glm(group ~ gender_comp + Var,
              data=dta_tmp,trace=F, family = "binomial")
  fit3 <- glm(group ~ age_recip + Var, 
              data=dta_tmp,trace=F, family = "binomial")
  fit4 <- glm(group ~ gender_comp + age_recip + Var, 
              data=dta_tmp,trace=F, family = "binomial")
  list(fit1, fit2, fit3, fit4)
})
```

```{r}
plots_gender_age(pdf_name = "../plots/metabo/rd/age_and_gender/tol_nontol_0.9.pdf",
                 norm_data = norm_data,
                 features = make.names(sel_com_names), compar = "TNT")

```





## Looking at differences between primary and secondary tolerant couples

I compute the permutation distribution for primary vs secondary tolerant donors:
```{r, eval=FALSE, echo=FALSE}
norm_data <- subst

norm_data <- norm_data[which(norm_data$group != "non_tolerant"),]
norm_data$group <- as.factor(as.character(norm_data$group))

# Calculate the perm_values on PRISM:
perm_vals_PRISM(norm_data, PRISM_name = "metabo_dr_prim_sec")

# Fetch the data back from PRISM
handle3 <- readRDS("handle_louis_donors_TNT.rds")
perm_vals<-qsub_retrieve(handle3)

save(perm_vals, file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/r&d/perm_vals_PS.RData")
save(norm_data, file = "~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/r&d/norm_data_PS.RData")
```

Visualise the resulting quantile values:
 In the first plot: quantile values of the models on metabolites one by one
 In the second plot: quantile values of the difference between group~ age+gender and group~ age+gender+metabolite
```{r}
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/r&d/norm_data_PS.RData")
load("~/Documents/VIB/Projects/Integrative_Paris/Integrative/outputs/data/metabo/r&d/perm_vals_PS.RData")
par(mfrow=c(2,1))
barplot(unlist(map(perm_vals, 1)))
barplot(unlist(map(perm_vals, 2)))
```

Compute the median per group for every gene, to use it later in the graphs:
```{r}
gr_medians <- norm_data %>%
  group_by(group) %>%
  summarize_if(is.numeric, median) %>%
  as.data.frame()
rownames(gr_medians) <- gr_medians$group
```

#### Threshold of 0.95

Selected metabolites for the couples, with a threshold on 0.95:
```{r}
qt <- unlist(map(perm_vals, 1))
densityplot(qt)
selected_metabolites_rd_qt <- colnames(norm_data)[which(qt>.95)+1]
write.xlsx(selected_metabolites_rd_qt, file = "../data/metabo/r&d/perm_val_PS_95_thresh.xlsx")
# selected_metabolites_rd_qt
print(paste0(length(selected_metabolites_rd_qt),
             " metabolites were selected with a 0.95 threshold in the St Louis cohort."))
```

Which of these metabolites were common in the cryostem cohort?
```{r}
sel_cryo <- read.xlsx("../data/metabo_national/r&d/perm_val_PS_95_thresh.xlsx", colNames = FALSE)
sel_common <- which(selected_metabolites_rd_qt %in% sel_cryo$X1)
length(sel_common)
sel_com_names <- selected_metabolites_rd_qt[sel_common]
sel_com_pretty_names <- gsub("subst_", "", sel_com_names)
sel_com_pretty_names 
write.xlsx(sel_com_pretty_names, file = "../data/metabo/r&d/excel_files_selected/metabo_ft_sel_dr_PS_95.xlsx")
```

```{r, echo = FALSE}
dir <- lapply(seq_len(length(sel_common)), function(idx){
  gene <- selected_metabolites_rd_qt[sel_common[idx]]
  overexp <- rownames(gr_medians)[which.is.max(gr_medians[gene][,1])]
  list(gene, overexp)
})
dir_genes <- do.call(rbind, dir)
write.xlsx(dir_genes, file = "../data/metabo/r&d/perm_val_dir_PS_95_thresh.xlsx")
```

#### Threshold of 0.90

Selected metabolites for the couples, with a threshold on 0.90:
```{r}
qt <- unlist(map(perm_vals, 1))
densityplot(qt)
selected_metabolites_rd_qt <- colnames(norm_data)[which(qt>.90)+1]
write.xlsx(selected_metabolites_rd_qt, file = "../data/metabo/r&d/perm_val_PS_90_thresh.xlsx")
print(paste0(length(selected_metabolites_rd_qt),
             " metabolites were selected with a 0.90 threshold in the St Louis cohort."))
```

Which of these metabolites were common in the cryostem cohort?
```{r}
sel_cryo <- read.xlsx("../data/metabo_national/r&d/perm_val_PS_90_thresh.xlsx", colNames = FALSE)
sel_common <- which(selected_metabolites_rd_qt %in% sel_cryo$X1)
length(sel_common)
sel_com_names <- selected_metabolites_rd_qt[sel_common]
sel_com_pretty_names <- gsub("subst_", "", sel_com_names)
sel_com_pretty_names 
```

Save these common features:
```{r}
metabo_ft_sel_rd_PS_90 <- norm_data[, c("group", sel_com_names)]
save(metabo_ft_sel_rd_PS_90,
     file = "../data/metabo/r&d/metabo_ft_sel_rd_PS_90.RData")
write.xlsx(sel_com_pretty_names, file = "../data/metabo/r&d/excel_files_selected/metabo_ft_sel_dr_PS_90.xlsx")
```

```{r, echo = FALSE}
dir <- lapply(seq_len(length(sel_common)), function(idx){
  gene <- selected_metabolites_rd_qt[sel_common[idx]]
  overexp <- rownames(gr_medians)[which.is.max(gr_medians[gene][,1])]
  list(gene, overexp)
})
dir_genes <- do.call(rbind, dir)
write.xlsx(dir_genes, file = "../data/metabo/r&d/perm_val_dir_PS_90_thresh.xlsx")
```


Random forest on the metabolites that are common between the donors of the 2 cohorts:
Selecting features has slightly improved the classification results:
```{r}
set.seed(1)
rf_d <- ranger::ranger(group~., norm_data[,c("group", selected_metabolites_rd_qt[sel_common])], num.trees = 1000,
importance = "impurity")
rf_d$confusion.matrix
paste0("prediction error: ", rf_d$prediction.error*100)
```


### Including age and gender in the analysis 

Now that we have selected features that seemed to play a role in tolerance that 
were common to both cohorts (with a threhold over 0.90), we decide to 
investigate into these features to see if some of them are related to the age
of the recipients, to the gender compatibility between the donor and recipient,
to both or to none of these two causes.

I first build new models using the features that were kept in the 
two cohorts as informative when comparing tolerant and non tolerant patients: 
```{r}
new_models <- lapply(seq_along(selected_metabolites_rd_qt[sel_common]), function(idx){
  dta_tmp <- norm_data[,c(selected_metabolites_rd_qt[sel_common][idx],
                        "group", "age_recip", "gender_comp")]
  colnames(dta_tmp)[1] <- "Var"
  fit1 <- glm(group ~ Var, data=dta_tmp,trace=F, family = "binomial")
  fit2 <- glm(group ~ gender_comp + Var,
              data=dta_tmp,trace=F, family = "binomial")
  fit3 <- glm(group ~ age_recip + Var, 
              data=dta_tmp,trace=F, family = "binomial")
  fit4 <- glm(group ~ gender_comp + age_recip + Var, 
              data=dta_tmp,trace=F, family = "binomial")
  list(fit1, fit2, fit3, fit4)
})
```

```{r}
plots_gender_age(pdf_name = "../plots/metabo/rd/age_and_gender/tol_nontol_0.9.pdf",
                 norm_data = norm_data,
                 features = selected_metabolites_rd_qt[sel_common], compar = "TNT")

```



# Combining the information on couples, recipients and donors:

Now that we have selected features at the recipient level, at the donor level 
and at the couple level, we can try to combine these features:

## Classifying non versus tolerant patients based on all the information:

We first combine the features that were selected as highly informative to 
classify between tolerant and non tolerant patients from the couples, recipients 
and donors into one big table:
```{r, echo = FALSE}
# couple info:
load("../data/metabo/r&d/metabo_ft_sel_rd_TNT_90.RData")
# add "couple_" in front of the feature names 
# colnames2keep <- which(colnames(metabo_ft_sel_rd_TNT_90) %in% c("group"))
# colnames(metabo_ft_sel_rd_TNT_90)[-colnames2keep] <-
#   gsub("X", "couple_", colnames(metabo_ft_sel_rd_TNT_90)[-colnames2keep])
# combine feature info with couple info about gender_comp...
pctgs_couples <- couple_info %>% 
  rownames_to_column("METABONAME") %>% 
  select("METABONAME", "COUPLENUMBER", "gender_comp", "age_recip") %>% 
  dplyr::filter(grepl("R", rownames(couple_info))) %>% 
  inner_join(metabo_ft_sel_rd_TNT_90 %>% 
               rownames_to_column("COUPLENUMBER") %>% 
               mutate(COUPLENUMBER = as.numeric(gsub("couple_", "", COUPLENUMBER))),
             by = "COUPLENUMBER")

# recip info:
metabo_ft_sel_recip_TNT_90 <- readRDS("../data/metabo/v2_012020/recip/pctgs_sel_ft_recip_TNT_90.RDS")
colnames2keep <- which(colnames(metabo_ft_sel_recip_TNT_90) %in% c("group"))
colnames(metabo_ft_sel_recip_TNT_90)[-colnames2keep] <-
  paste0("R_", colnames(metabo_ft_sel_recip_TNT_90)[-colnames2keep])
pctgs_recip <- couple_info %>% 
  rownames_to_column("METABONAME") %>% 
  select("COUPLENUMBER", "METABONAME") %>% 
  right_join(metabo_ft_sel_recip_TNT_90 %>% 
               rownames_to_column("METABONAME"), by = "METABONAME")

# donor info :
metabo_donor_louis_TNT <- readRDS("../data/metabo/v2_012020/donors/pctgs_sel_ft_donors_TNT_90.RDS")
colnames2keep <- which(colnames(metabo_donor_louis_TNT) %in% c("group"))
colnames(metabo_donor_louis_TNT)[-colnames2keep] <-
  paste0("D_", colnames(metabo_donor_louis_TNT)[-colnames2keep])
pctgs_donor <- couple_info %>% 
  rownames_to_column("METABONAME") %>% 
  select("METABONAME", "COUPLENUMBER") %>% 
  right_join(metabo_donor_louis_TNT %>% 
               rownames_to_column("METABONAME"), by = "METABONAME") 

# combine :
pctgs_all <- pctgs_couples %>% 
  left_join(pctgs_recip, by = c("METABONAME", "COUPLENUMBER","group")) %>% 
  left_join(pctgs_donor, by = c("COUPLENUMBER", "group")) %>% 
  select(-"METABONAME.y")
```

We can generate a PCA and a tSNE using all these features to see how the tolerant 
and non tolerant patients are represented in the reduced dimensions:
```{r, echo = FALSE}
pctgs_all_only <- pctgs_all %>%
  column_to_rownames("COUPLENUMBER") %>% 
  select_if(is.numeric) %>% 
  select(-"age_recip")

pca_all <- prcomp(pctgs_all_only)
```

The 2 first components of the PCA seem to hold quite a lot of the variability in the data:
```{r}
plot(pca_all)
```

```{r}
set.seed(1)
pca_2plot <- as.data.frame(pca_all$x) %>% 
  mutate(COUPLENUMBER = as.numeric(rownames(pca_all$x))) %>% 
  left_join(pctgs_all, by = "COUPLENUMBER")
samp_tmp <- samp_rd %>% filter(!is.na(METABONAME)) %>% 
  column_to_rownames("METABONAME")
samp_tmp <- samp_tmp[pca_2plot$METABONAME.x,]

pca_2plot<- pca_2plot %>% mutate(Id.Cryostem = samp_tmp$Id.Cryostem.R)

ggplot(pca_2plot, aes(x = PC1, y = PC2, col = as.factor(group), label = Id.Cryostem)) + 
  geom_point() +
  geom_text(aes(label=Id.Cryostem),hjust=0, vjust=0)
```
The non tolerant patients seem to be situated more on the left of the PCA, and 
the tolerant patients seem to be situated more to the right, which suggests 
that we might have extracted some information allowing us to classify the 
St Louis patients based on the features that we selected.

We can also generate a tSNE on the same data:
```{r}
set.seed(1)
tsne_all <- Rtsne::Rtsne(pctgs_all_only, perplexity = 10)
tsne_2plot <- as.data.frame(tsne_all$Y) %>% 
  magrittr::set_colnames(c("X1", "X2")) %>% 
  mutate(COUPLENUMBER = as.numeric(rownames(pctgs_all_only))) %>% 
  left_join(pctgs_all, by = "COUPLENUMBER")

tsne_2plot<- tsne_2plot %>% mutate(Id.Cryostem = samp_tmp$Id.Cryostem.R)

ggplot(tsne_2plot, aes(x = X1, y = X2, col = as.factor(group), 
                       label = Id.Cryostem)) + 
  geom_point() +
  geom_text(aes(label=Id.Cryostem),hjust=0, vjust=0)
```


We can see if building a model using all these features combined leads to good 
classification results between tolerant and non tolerant patients:
```{r}
pctgs_all_RF <- pctgs_all %>% 
  select(-"COUPLENUMBER", -"gender_comp", -"age_recip") %>% 
  mutate(group = as.factor(group)) %>% 
  column_to_rownames("METABONAME.x")

set.seed(1)
nb_features = ncol(pctgs_all_RF)-1

rf <- rf_tol_non_tol(df_orig = pctgs_all_RF,
                      mtry = round(sqrt(nb_features)), ntree = 1000, package_2use = "ranger")
rf$confusion.matrix
paste0("prediction error: ", rf$prediction.error*100)
```

The random forest model seems to have benefitted a lot of the feature selection,
only one patient is misclassified.
We can see which features were selected in the model to classify tolerant 
from non tolerant patients in the St Louis cohort:
```{r, echo = FALSE}
sort(rf$variable.importance, decreasing = TRUE)[1:20]
```

And visualise the top variables in a heatmap:
```{r}
mat2plot <- pctgs_all_RF[,c("group", names(sort(rf$variable.importance, decreasing = TRUE))[1:20])] %>% 
  rownames_to_column("rownames") %>% 
  arrange(group) %>% 
  column_to_rownames("rownames")

annot_patients <- as.data.frame(mat2plot$group)
rownames(annot_patients) <- rownames(mat2plot)
colnames(annot_patients) <- "group"
ann_colors <- list(group = c(non_tolerant = "indianred1", 
                             tolerant = "royalblue1"))

pheatmap::pheatmap(mat2plot[,-which(colnames(mat2plot)=="group")], 
                   annotation_row = annot_patients,
                   annotation_colors = ann_colors[1],
                   cluster_rows = FALSE,
                   cluster_cols = FALSE,
                   main = "Heatmap with patients ordered by group",
                   scale = "column")

pheatmap::pheatmap(mat2plot[,-which(colnames(mat2plot)=="group")], 
                   annotation_row = annot_patients,
                   annotation_colors = ann_colors[1],
                   cluster_rows = TRUE,
                   main = "Heatmap with patients clustered",
                   scale = "column")
```

Reminder: high values for the variables that start with "subst_" mean that the
difference of expression between the donor and the recipient of the same couple 
was high for this specific feature.


## Classifying non versus tolerant patients based only on the metabolites that were common to both cohorts AND behaved similarily:

We first combine the features that were selected as highly informative to 
classify between tolerant and non tolerant patients from the couples, recipients 
and donors into one big table:
```{r, echo = FALSE}
# couple info:
beh <- read.xlsx("../data/metabo/r&d/perm_val_beh_TNT_90_thresh.xlsx")
load("../data/metabo/r&d/metabo_ft_sel_rd_TNT_90.RData")
metabo_ft_sel_rd_TNT_90 <- metabo_ft_sel_rd_TNT_90[, c("group", beh$sel_beh)]
pctgs_couples <- couple_info %>% 
  rownames_to_column("METABONAME") %>% 
  select("METABONAME", "COUPLENUMBER", "gender_comp", "age_recip") %>% 
  dplyr::filter(grepl("R", rownames(couple_info))) %>% 
  inner_join(metabo_ft_sel_rd_TNT_90 %>% 
               rownames_to_column("COUPLENUMBER") %>% 
               mutate(COUPLENUMBER = as.numeric(gsub("couple_", "", COUPLENUMBER))),
             by = "COUPLENUMBER")

# recip info:
beh <- read.xlsx("../data/metabo/v2_012020/recip/perm_val_beh_TNT_90_thresh.xlsx")
metabo_ft_sel_recip_TNT_90 <- readRDS("../data/metabo/v2_012020/recip/pctgs_sel_ft_recip_TNT_90.RDS")
metabo_ft_sel_recip_TNT_90 <- metabo_ft_sel_recip_TNT_90[, c("group", beh$features)]
colnames2keep <- which(colnames(metabo_ft_sel_recip_TNT_90) %in% c("group"))
colnames(metabo_ft_sel_recip_TNT_90)[-colnames2keep] <-
  paste0("R_", colnames(metabo_ft_sel_recip_TNT_90)[-colnames2keep])
pctgs_recip <- couple_info %>% 
  rownames_to_column("METABONAME") %>% 
  select("COUPLENUMBER", "METABONAME") %>% 
  right_join(metabo_ft_sel_recip_TNT_90 %>% 
               rownames_to_column("METABONAME"), by = "METABONAME")

# donor info :
beh <- read.xlsx("../data/metabo/v2_012020/donors/perm_val_beh_TNT_90_thresh.xlsx")
metabo_donor_louis_TNT <- readRDS("../data/metabo/v2_012020/donors/pctgs_sel_ft_donors_TNT_90.RDS")
metabo_donor_louis_TNT <- metabo_donor_louis_TNT[, c("group", beh$features)]
colnames2keep <- which(colnames(metabo_donor_louis_TNT) %in% c("group"))
colnames(metabo_donor_louis_TNT)[-colnames2keep] <-
  paste0("D_", colnames(metabo_donor_louis_TNT)[-colnames2keep])
pctgs_donor <- couple_info %>% 
  rownames_to_column("METABONAME") %>% 
  select("METABONAME", "COUPLENUMBER") %>% 
  right_join(metabo_donor_louis_TNT %>% 
               rownames_to_column("METABONAME"), by = "METABONAME") 

# combine :
pctgs_all <- pctgs_couples %>% 
  left_join(pctgs_recip, by = c("METABONAME", "COUPLENUMBER","group")) %>% 
  left_join(pctgs_donor, by = c("COUPLENUMBER", "group")) %>% 
  select(-"METABONAME.y")
```

We can generate a PCA and a tSNE using all these features to see how the tolerant 
and non tolerant patients are represented in the reduced dimensions:
```{r, echo = FALSE}
pctgs_all_only <- pctgs_all %>%
  column_to_rownames("COUPLENUMBER") %>% 
  select_if(is.numeric) %>% 
  select(-"age_recip")

pca_all <- prcomp(pctgs_all_only)
```

The 2 first components of the PCA seem to hold quite a lot of the variability in the data:
```{r}
plot(pca_all)
```

```{r}
set.seed(1)
pca_2plot <- as.data.frame(pca_all$x) %>% 
  mutate(COUPLENUMBER = as.numeric(rownames(pca_all$x))) %>% 
  left_join(pctgs_all, by = "COUPLENUMBER")
samp_tmp <- samp_rd %>% filter(!is.na(METABONAME)) %>% 
  column_to_rownames("METABONAME")
samp_tmp <- samp_tmp[pca_2plot$METABONAME.x,]

pca_2plot<- pca_2plot %>% mutate(Id.Cryostem = samp_tmp$Id.Cryostem.R)

ggplot(pca_2plot, aes(x = PC1, y = PC2, col = as.factor(group), label = Id.Cryostem)) + 
  geom_point() +
  geom_text(aes(label=Id.Cryostem),hjust=0, vjust=0)
```
The non tolerant patients seem to be situated more on the left of the PCA, and 
the tolerant patients seem to be situated more to the right, which suggests 
that we might have extracted some information allowing us to classify the 
St Louis patients based on the features that we selected.

We can also generate a tSNE on the same data:
```{r}
set.seed(1)
tsne_all <- Rtsne::Rtsne(pctgs_all_only, perplexity = 10)
tsne_2plot <- as.data.frame(tsne_all$Y) %>% 
  magrittr::set_colnames(c("X1", "X2")) %>% 
  mutate(COUPLENUMBER = as.numeric(rownames(pctgs_all_only))) %>% 
  left_join(pctgs_all, by = "COUPLENUMBER")

tsne_2plot<- tsne_2plot %>% mutate(Id.Cryostem = samp_tmp$Id.Cryostem.R)

ggplot(tsne_2plot, aes(x = X1, y = X2, col = as.factor(group), 
                       label = Id.Cryostem)) + 
  geom_point() +
  geom_text(aes(label=Id.Cryostem),hjust=0, vjust=0)
```


We can see if building a model using all these features combined leads to good 
classification results between tolerant and non tolerant patients:
```{r}
pctgs_all_RF <- pctgs_all %>% 
  select(-"COUPLENUMBER", -"gender_comp", -"age_recip") %>% 
  mutate(group = as.factor(group)) %>% 
  column_to_rownames("METABONAME.x")

set.seed(1)
nb_features = ncol(pctgs_all_RF)-1

rf <- rf_tol_non_tol(df_orig = pctgs_all_RF,
                      mtry = round(sqrt(nb_features)), ntree = 1000, package_2use = "ranger")
rf$confusion.matrix
paste0("prediction error: ", rf$prediction.error*100)
```

The random forest model seems to have benefitted a lot of the feature selection,
only one patient is misclassified.
We can see which features were selected in the model to classify tolerant 
from non tolerant patients in the St Louis cohort:
```{r, echo = FALSE}
sort(rf$variable.importance, decreasing = TRUE)[1:20]
```

And visualise the top variables in a heatmap:
```{r}
mat2plot <- pctgs_all_RF[,c("group", names(sort(rf$variable.importance, decreasing = TRUE))[1:20])] %>% 
  rownames_to_column("rownames") %>% 
  arrange(group) %>% 
  column_to_rownames("rownames")

annot_patients <- as.data.frame(mat2plot$group)
rownames(annot_patients) <- rownames(mat2plot)
colnames(annot_patients) <- "group"
ann_colors <- list(group = c(non_tolerant = "indianred1", 
                             tolerant = "royalblue1"))

pheatmap::pheatmap(mat2plot[,-which(colnames(mat2plot)=="group")], 
                   annotation_row = annot_patients,
                   annotation_colors = ann_colors[1],
                   cluster_rows = FALSE,
                   cluster_cols = FALSE,
                   main = "Heatmap with patients ordered by group",
                   scale = "column")

pheatmap::pheatmap(mat2plot[,-which(colnames(mat2plot)=="group")], 
                   annotation_row = annot_patients,
                   annotation_colors = ann_colors[1],
                   cluster_rows = TRUE,
                   main = "Heatmap with patients clustered",
                   scale = "column")
```

Reminder: high values for the variables that start with "subst_" mean that the
difference of expression between the donor and the recipient of the same couple 
was high for this specific feature.


## Classifying primary versus secondary tolerant patients based on all the information:

We first combine the features that were selected as highly informative to 
classify between primary and secondary tolerant patients from the couples, 
recipients and donors into one big table:
```{r, echo = FALSE}
# couple info:
load("../data/metabo/r&d/metabo_ft_sel_rd_PS_90.RData")
pctgs_couples <- couple_info %>% 
  rownames_to_column("METABONAME") %>% 
  select("METABONAME", "COUPLENUMBER", "gender_comp", "age_recip") %>% 
  dplyr::filter(grepl("R", rownames(couple_info))) %>% 
  inner_join(metabo_ft_sel_rd_PS_90 %>% 
               rownames_to_column("COUPLENUMBER") %>% 
               mutate(COUPLENUMBER = as.numeric(gsub("couple_", "", COUPLENUMBER))),
             by = "COUPLENUMBER")

# recip info:
metabo_ft_sel_recip_PS_90 <- readRDS("../data/metabo/v2_012020/recip/pctgs_sel_ft_recip_PTST_90.RDS")
colnames2keep <- which(colnames(metabo_ft_sel_recip_PS_90) %in% c("group"))
colnames(metabo_ft_sel_recip_PS_90)[-colnames2keep] <-
  paste0("R_", colnames(metabo_ft_sel_recip_PS_90)[-colnames2keep])
pctgs_recip <- couple_info %>% 
  rownames_to_column("METABONAME") %>% 
  select("COUPLENUMBER", "METABONAME") %>% 
  right_join(metabo_ft_sel_recip_PS_90 %>% 
               rownames_to_column("METABONAME"), by = "METABONAME")

# donor info :
metabo_donor_louis_PS <- readRDS("../data/metabo/v2_012020/donors/pctgs_sel_ft_donors_PTST_90.RDS")
colnames2keep <- which(colnames(metabo_donor_louis_PS) %in% c("group"))
colnames(metabo_donor_louis_PS)[-colnames2keep] <-
  paste0("D_", colnames(metabo_donor_louis_PS)[-colnames2keep])
pctgs_donors <- couple_info %>% 
  rownames_to_column("METABONAME") %>% 
  select("COUPLENUMBER", "METABONAME") %>% 
  right_join(metabo_donor_louis_PS %>% 
               rownames_to_column("METABONAME"), by = "METABONAME")

# combine :
pctgs_all <- pctgs_couples %>% 
  left_join(pctgs_recip, by = c("METABONAME", "COUPLENUMBER","group")) %>% 
  left_join(pctgs_donors, by = c("COUPLENUMBER", "group")) %>% 
  select(-"METABONAME.y")
```

We can generate a PCA and a tSNE using all these features to see how the tolerant 
and non tolerant patients are represented in the reduced dimensions:
```{r}
pctgs_all_only <- pctgs_all %>%
  column_to_rownames("COUPLENUMBER") %>% 
  select_if(is.numeric) %>% 
  select(-"age_recip")

pca_all <- prcomp(pctgs_all_only)
```

The first component of the PCA seems to hold most of the variability in the data by far:
```{r}
plot(pca_all)
```

```{r}
set.seed(1)
pca_2plot <- as.data.frame(pca_all$x) %>% 
  mutate(COUPLENUMBER = as.numeric(rownames(pca_all$x))) %>% 
  left_join(pctgs_all, by = "COUPLENUMBER")

samp_tmp <- samp_rd %>% filter(!is.na(METABONAME)) %>% 
  column_to_rownames("METABONAME")
samp_tmp <- samp_tmp[pca_2plot$METABONAME.x,]
pca_2plot<- pca_2plot %>% mutate(Id.Cryostem = samp_tmp$Id.Cryostem.R)

ggplot(pca_2plot, aes(x = PC1, y = PC2, col = as.factor(group), label = Id.Cryostem)) + 
  geom_point() +
  scale_color_manual(breaks = c("primary_tolerant", "secondary_tolerant"),
                     values = c("springgreen3", "royalblue1"))+
  geom_text(aes(label=Id.Cryostem),hjust=0, vjust=0)
```

It seems like the primary and secondary patients are quite separated in the PCA.

We can also generate a tSNE on the same data:
```{r}
tsne_all <- Rtsne::Rtsne(pctgs_all_only, perplexity = 3)
tsne_2plot <- as.data.frame(tsne_all$Y) %>% 
  magrittr::set_colnames(c("X1", "X2")) %>% 
  mutate(COUPLENUMBER = as.numeric(rownames(pctgs_all_only))) %>% 
  left_join(pctgs_all, by = "COUPLENUMBER")
tsne_2plot<- tsne_2plot %>% mutate(Id.Cryostem = samp_tmp$Id.Cryostem.R)

ggplot(tsne_2plot, aes(x = X1, y = X2, col = as.factor(group), 
                       label = Id.Cryostem)) + 
  geom_point() +
  scale_color_manual(breaks = c("primary_tolerant", "secondary_tolerant"),
                     values = c("springgreen3", "royalblue1")) +
  geom_text(aes(label=Id.Cryostem),hjust=0, vjust=0)
```


We can see if building a model using all these features combined leads to good 
classification results between primary and secondary tolerant patients:
```{r}
pctgs_all_RF <- pctgs_all %>% 
  select(-"COUPLENUMBER", -"gender_comp", -"age_recip") %>% 
  mutate(group = as.factor(group)) %>% 
  column_to_rownames("METABONAME.x")

set.seed(1)
rf <- ranger::ranger(group~., data = pctgs_all_RF, num.trees = 5000, importance = "impurity")
rf$confusion.matrix
paste0("prediction error: ", rf$prediction.error*100)
```

We can see which features were selected in the model to classify primary and 
secondary tolerant patients in the St Louis cohort:
```{r, echo = FALSE}
sort(rf$variable.importance, decreasing = TRUE)
```

We can visualise the top variables in a heatmap:
```{r}
mat2plot <- pctgs_all_RF[,c("group", names(sort(rf$variable.importance, decreasing = TRUE)))] %>% 
  rownames_to_column("rownames") %>% 
  arrange(group) %>% 
  column_to_rownames("rownames")

annot_patients <- as.data.frame(mat2plot$group)
rownames(annot_patients) <- rownames(mat2plot)
colnames(annot_patients) <- "group"
ann_colors <- list(group = c(primary_tolerant = "springgreen3", 
                             secondary_tolerant = "royalblue1"))

pheatmap::pheatmap(mat2plot[,-which(colnames(mat2plot)=="group")], 
                   annotation_row = annot_patients,
                   annotation_colors = ann_colors[1],
                   cluster_rows = FALSE,
                   cluster_cols = FALSE,
                   main = "Heatmap with patients ordered by group",
                   scale = "column")

pheatmap::pheatmap(mat2plot[,-which(colnames(mat2plot)=="group")], 
                   annotation_row = annot_patients,
                   annotation_colors = ann_colors[1],
                   cluster_rows = TRUE,
                   main = "Heatmap with patients clustered",
                   scale = "column")
```

Reminder: high values for the variables that start with "couple_" mean that the
difference of expression between the donor and the recipient of the same couple 
was high for this specific feature.


## Focusing on the features that had the same behaviour in both cohorts:

We first combine the features that were selected as highly informative to 
classify between primary and secondary tolerant patients from the couples, 
recipients and donors into one big table:
```{r, echo = FALSE}
# couple info:
beh <- read.xlsx("../data/metabo/r&d/perm_val_beh_PS_90_thresh.xlsx")
load("../data/metabo/r&d/metabo_ft_sel_rd_PS_90.RData")
metabo_ft_sel_rd_PS_90 <- metabo_ft_sel_rd_PS_90[, c("group", beh$sel_beh)]
pctgs_couples <- couple_info %>% 
  rownames_to_column("METABONAME") %>% 
  select("METABONAME", "COUPLENUMBER", "gender_comp", "age_recip") %>% 
  dplyr::filter(grepl("R", rownames(couple_info))) %>% 
  inner_join(metabo_ft_sel_rd_PS_90 %>% 
               rownames_to_column("COUPLENUMBER") %>% 
               mutate(COUPLENUMBER = as.numeric(gsub("couple_", "", COUPLENUMBER))),
             by = "COUPLENUMBER")

# recip info:
beh <- read.xlsx("../data/metabo/v2_012020/recip/perm_val_beh_PTST_90_thresh.xlsx")
metabo_ft_sel_recip_PS_90 <- readRDS("../data/metabo/v2_012020/recip/pctgs_sel_ft_recip_PTST_90.RDS")
metabo_ft_sel_recip_PS_90 <- metabo_ft_sel_recip_PS_90[, c("group", beh$features)]
colnames2keep <- which(colnames(metabo_ft_sel_recip_PS_90) %in% c("group"))
colnames(metabo_ft_sel_recip_PS_90)[-colnames2keep] <-
  paste0("R_", colnames(metabo_ft_sel_recip_PS_90)[-colnames2keep])
pctgs_recip <- couple_info %>% 
  rownames_to_column("METABONAME") %>% 
  select("COUPLENUMBER", "METABONAME") %>% 
  right_join(metabo_ft_sel_recip_PS_90 %>% 
               rownames_to_column("METABONAME"), by = "METABONAME")

# donor info :
beh <- read.xlsx("../data/metabo/v2_012020/donors/perm_val_beh_PTST_90_thresh.xlsx")
metabo_donor_louis_PS <- readRDS("../data/metabo/v2_012020/donors/pctgs_sel_ft_donors_PTST_90.RDS")
metabo_donor_louis_PS <- metabo_donor_louis_PS[, c("group", beh$features)]
colnames2keep <- which(colnames(metabo_donor_louis_PS) %in% c("group"))
colnames(metabo_donor_louis_PS)[-colnames2keep] <-
  paste0("D_", colnames(metabo_donor_louis_PS)[-colnames2keep])
pctgs_donors <- couple_info %>% 
  rownames_to_column("METABONAME") %>% 
  select("COUPLENUMBER", "METABONAME") %>% 
  right_join(metabo_donor_louis_PS %>% 
               rownames_to_column("METABONAME"), by = "METABONAME")

# combine :
pctgs_all <- pctgs_couples %>% 
  left_join(pctgs_recip, by = c("METABONAME", "COUPLENUMBER","group")) %>% 
  left_join(pctgs_donors, by = c("COUPLENUMBER", "group")) %>% 
  select(-"METABONAME.y")
```

We can generate a PCA and a tSNE using all these features to see how the tolerant 
and non tolerant patients are represented in the reduced dimensions:
```{r}
pctgs_all_only <- pctgs_all %>%
  column_to_rownames("COUPLENUMBER") %>% 
  select_if(is.numeric) %>% 
  select(-"age_recip")

pca_all <- prcomp(pctgs_all_only)
```

The first component of the PCA seems to hold most of the variability in the data by far:
```{r}
plot(pca_all)
```

```{r}
set.seed(1)
pca_2plot <- as.data.frame(pca_all$x) %>% 
  mutate(COUPLENUMBER = as.numeric(rownames(pca_all$x))) %>% 
  left_join(pctgs_all, by = "COUPLENUMBER")

samp_tmp <- samp_rd %>% filter(!is.na(METABONAME)) %>% 
  column_to_rownames("METABONAME")
samp_tmp <- samp_tmp[pca_2plot$METABONAME.x,]
pca_2plot<- pca_2plot %>% mutate(Id.Cryostem = samp_tmp$Id.Cryostem.R)

ggplot(pca_2plot, aes(x = PC1, y = PC2, col = as.factor(group), label = Id.Cryostem)) + 
  geom_point() +
  scale_color_manual(breaks = c("primary_tolerant", "secondary_tolerant"),
                     values = c("springgreen3", "royalblue1"))+
  geom_text(aes(label=Id.Cryostem),hjust=0, vjust=0)
```

It seems like the primary and secondary patients are quite separated in the PCA.

We can also generate a tSNE on the same data:
```{r}
tsne_all <- Rtsne::Rtsne(pctgs_all_only, perplexity = 3)
tsne_2plot <- as.data.frame(tsne_all$Y) %>% 
  magrittr::set_colnames(c("X1", "X2")) %>% 
  mutate(COUPLENUMBER = as.numeric(rownames(pctgs_all_only))) %>% 
  left_join(pctgs_all, by = "COUPLENUMBER")
tsne_2plot<- tsne_2plot %>% mutate(Id.Cryostem = samp_tmp$Id.Cryostem.R)

ggplot(tsne_2plot, aes(x = X1, y = X2, col = as.factor(group), 
                       label = Id.Cryostem)) + 
  geom_point() +
  scale_color_manual(breaks = c("primary_tolerant", "secondary_tolerant"),
                     values = c("springgreen3", "royalblue1")) +
  geom_text(aes(label=Id.Cryostem),hjust=0, vjust=0)
```


We can see if building a model using all these features combined leads to good 
classification results between primary and secondary tolerant patients:
```{r}
pctgs_all_RF <- pctgs_all %>% 
  select(-"COUPLENUMBER", -"gender_comp", -"age_recip") %>% 
  mutate(group = as.factor(group)) %>% 
  column_to_rownames("METABONAME.x")

set.seed(1)
rf <- ranger::ranger(group~., data = pctgs_all_RF, num.trees = 5000, importance = "impurity")
rf$confusion.matrix
paste0("prediction error: ", rf$prediction.error*100)
```

We can see which features were selected in the model to classify primary and 
secondary tolerant patients in the St Louis cohort:
```{r, echo = FALSE}
sort(rf$variable.importance, decreasing = TRUE)
```

We can visualise the top variables in a heatmap:
```{r}
mat2plot <- pctgs_all_RF[,c("group", names(sort(rf$variable.importance, decreasing = TRUE)))] %>% 
  rownames_to_column("rownames") %>% 
  arrange(group) %>% 
  column_to_rownames("rownames")

annot_patients <- as.data.frame(mat2plot$group)
rownames(annot_patients) <- rownames(mat2plot)
colnames(annot_patients) <- "group"
ann_colors <- list(group = c(primary_tolerant = "springgreen3", 
                             secondary_tolerant = "royalblue1"))

pheatmap::pheatmap(mat2plot[,-which(colnames(mat2plot)=="group")], 
                   annotation_row = annot_patients,
                   annotation_colors = ann_colors[1],
                   cluster_rows = FALSE,
                   cluster_cols = FALSE,
                   main = "Heatmap with patients ordered by group",
                   scale = "column")

pheatmap::pheatmap(mat2plot[,-which(colnames(mat2plot)=="group")], 
                   annotation_row = annot_patients,
                   annotation_colors = ann_colors[1],
                   cluster_rows = TRUE,
                   main = "Heatmap with patients clustered",
                   scale = "column")
```

Reminder: high values for the variables that start with "couple_" mean that the
difference of expression between the donor and the recipient of the same couple 
was high for this specific feature.
